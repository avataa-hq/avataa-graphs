import pytest


@pytest.fixture(scope="function", autouse=True)
def create_first_graph(client):
    req = {"tmo_id": 42588, "name": "first_graph"}
    res = client.post(url="/api/graph/v1/initialisation/", json=req)
    assert res.status_code == 202


def remove_keys_from_response(data: dict, key_to_delete: str, attrs: list[str]):
    """
    Arango has a specific function -- it randomly generates "ids" that are called "keys".
    Because we generate new objects with each test -- new keys are generated, and it is hard
    to keep track of the accuracy of the result,
    so this method removes the key or other (source/target) fields that are generated by Arango,
    and checks if that value is in the result at all.
    """
    for edge in data[key_to_delete]:
        for attr in attrs:
            assert attr in edge
            del edge[attr]
    return data


def test_get_tmo_data(client, arango_client):
    """
    GET /api/graph/tmo/{key}

        Test tmo get data if, initialisation was correct
    """
    graphs = client.get(url="/api/graph/v1/initialisation/")
    graph_key = graphs.json()[0]["key"]

    response_from_server_by_tmo_data = client.get(
        url=f"/api/graph/v1/tmo/{graph_key}"
    )
    assert response_from_server_by_tmo_data.status_code == 200
    expected_response = {
        "start_node_key": "42588",
        "nodes": [
            {
                "key": "42588",
                "name": "Transport Network Small",
                "virtual": True,
                "global_uniqueness": True,
                "id": 42588,
                "materialize": False,
                "enabled": True,
                "is_grouped": False,
                "icon": "AccessibleForward",
                "geometry_type": None,
                "line_type": None,
                "params": [],
                "commutation_tprms": None,
                "show_as_a_table": True,
                "busy_parameter_groups": [],
            },
            {
                "key": "42622",
                "name": "Service Small",
                "virtual": False,
                "global_uniqueness": True,
                "id": 42622,
                "materialize": False,
                "enabled": True,
                "is_grouped": False,
                "icon": None,
                "geometry_type": None,
                "line_type": None,
                "params": [{"name": "Name", "val_type": "str", "id": 125951}],
                "commutation_tprms": None,
                "show_as_a_table": True,
                "busy_parameter_groups": [],
            },
            {
                "key": "42589",
                "name": "Location Small",
                "virtual": False,
                "global_uniqueness": True,
                "id": 42589,
                "materialize": False,
                "enabled": True,
                "is_grouped": False,
                "icon": "LocationOn",
                "geometry_type": None,
                "line_type": None,
                "params": [
                    {"name": "Name", "val_type": "str", "id": 125943},
                    {"name": "Latitude", "val_type": "float", "id": 125897},
                    {"name": "Longitude", "val_type": "float", "id": 125898},
                ],
                "commutation_tprms": None,
                "show_as_a_table": True,
                "busy_parameter_groups": [],
            },
            {
                "key": "42590",
                "name": "Sites Small",
                "virtual": False,
                "global_uniqueness": True,
                "id": 42590,
                "materialize": False,
                "enabled": True,
                "is_grouped": False,
                "icon": "CellTower",
                "geometry_type": None,
                "line_type": None,
                "params": [{"name": "Name", "val_type": "str", "id": 125914}],
                "commutation_tprms": None,
                "show_as_a_table": True,
                "busy_parameter_groups": [],
            },
            {
                "key": "42604",
                "name": "Site Port",
                "virtual": False,
                "global_uniqueness": False,
                "id": 42604,
                "materialize": False,
                "enabled": True,
                "is_grouped": False,
                "icon": "ImportExport",
                "geometry_type": None,
                "line_type": None,
                "params": [
                    {"name": "Name", "val_type": "str", "id": 125921},
                    {"name": "Trace", "val_type": "mo_link", "id": 125952},
                ],
                "commutation_tprms": None,
                "show_as_a_table": True,
                "busy_parameter_groups": [],
            },
            {
                "key": "42599",
                "name": "Optical Cross Small",
                "virtual": False,
                "global_uniqueness": True,
                "id": 42599,
                "materialize": False,
                "enabled": True,
                "is_grouped": False,
                "icon": "HdrStrong",
                "geometry_type": None,
                "line_type": None,
                "params": [{"name": "Name", "val_type": "str", "id": 125913}],
                "commutation_tprms": None,
                "show_as_a_table": True,
                "busy_parameter_groups": [],
            },
            {
                "key": "42616",
                "name": "Optical Cross Thread ",
                "virtual": False,
                "global_uniqueness": False,
                "id": 42616,
                "materialize": False,
                "enabled": True,
                "is_grouped": False,
                "icon": "ImportExport",
                "geometry_type": None,
                "line_type": None,
                "params": [
                    {"name": "Trace", "val_type": "mo_link", "id": 125955},
                    {"name": "Name", "val_type": "str", "id": 125941},
                ],
                "commutation_tprms": None,
                "show_as_a_table": True,
                "busy_parameter_groups": [],
            },
            {
                "key": "42600",
                "name": "Swith",
                "virtual": False,
                "global_uniqueness": True,
                "id": 42600,
                "materialize": False,
                "enabled": True,
                "is_grouped": False,
                "icon": "ToggleOff",
                "geometry_type": None,
                "line_type": None,
                "params": [{"name": "Name", "val_type": "str", "id": 125944}],
                "commutation_tprms": None,
                "show_as_a_table": True,
                "busy_parameter_groups": [],
            },
            {
                "key": "42617",
                "name": "Swith Port",
                "virtual": False,
                "global_uniqueness": False,
                "id": 42617,
                "materialize": False,
                "enabled": True,
                "is_grouped": False,
                "icon": "ImportExport",
                "geometry_type": None,
                "line_type": None,
                "params": [
                    {"name": "Name", "val_type": "str", "id": 125942},
                    {"name": "Trace", "val_type": "mo_link", "id": 125956},
                ],
                "commutation_tprms": None,
                "show_as_a_table": True,
                "busy_parameter_groups": [],
            },
            {
                "key": "42592",
                "name": "Fiber Cable Small",
                "virtual": False,
                "global_uniqueness": True,
                "id": 42592,
                "materialize": False,
                "enabled": True,
                "is_grouped": False,
                "icon": "FiberSmartRecord",
                "geometry_type": None,
                "line_type": None,
                "params": [{"name": "Name", "val_type": "str", "id": 125911}],
                "commutation_tprms": None,
                "show_as_a_table": True,
                "busy_parameter_groups": [],
            },
            {
                "key": "42611",
                "name": "Fiber Cable Thread",
                "virtual": False,
                "global_uniqueness": False,
                "id": 42611,
                "materialize": False,
                "enabled": True,
                "is_grouped": False,
                "icon": "ImportExport",
                "geometry_type": None,
                "line_type": None,
                "params": [
                    {"name": "Trace", "val_type": "mo_link", "id": 125954},
                    {"name": "Name", "val_type": "str", "id": 125930},
                ],
                "commutation_tprms": None,
                "show_as_a_table": True,
                "busy_parameter_groups": [],
            },
            {
                "key": "42591",
                "name": "Microwave Small",
                "virtual": False,
                "global_uniqueness": True,
                "id": 42591,
                "materialize": False,
                "enabled": True,
                "is_grouped": False,
                "icon": "Waves",
                "geometry_type": None,
                "line_type": None,
                "params": [{"name": "Name", "val_type": "str", "id": 125912}],
                "commutation_tprms": None,
                "show_as_a_table": True,
                "busy_parameter_groups": [],
            },
            {
                "key": "42610",
                "name": "Microwave Port",
                "virtual": False,
                "global_uniqueness": False,
                "id": 42610,
                "materialize": False,
                "enabled": True,
                "is_grouped": False,
                "icon": "ImportExport",
                "geometry_type": None,
                "line_type": None,
                "params": [
                    {"name": "Trace", "val_type": "mo_link", "id": 125953},
                    {"name": "Name", "val_type": "str", "id": 125933},
                ],
                "commutation_tprms": None,
                "show_as_a_table": True,
                "busy_parameter_groups": [],
            },
        ],
        "edges": [
            {
                "key": "272",
                "source": "42622",
                "target": "42588",
                "link_type": "p_id",
                "enabled": True,
                "tprm_id": None,
            },
            {
                "key": "273",
                "source": "42589",
                "target": "42588",
                "link_type": "p_id",
                "enabled": True,
                "tprm_id": None,
            },
            {
                "key": "274",
                "source": "42590",
                "target": "42589",
                "link_type": "p_id",
                "enabled": True,
                "tprm_id": None,
            },
            {
                "key": "275",
                "source": "42604",
                "target": "42590",
                "link_type": "p_id",
                "enabled": True,
                "tprm_id": None,
            },
            {
                "key": "276",
                "source": "42599",
                "target": "42611",
                "link_type": "point_tmo_constraint",
                "enabled": True,
                "tprm_id": None,
            },
            {
                "key": "277",
                "source": "42599",
                "target": "42589",
                "link_type": "p_id",
                "enabled": True,
                "tprm_id": None,
            },
            {
                "key": "278",
                "source": "42616",
                "target": "42611",
                "link_type": "point_tmo_constraint",
                "enabled": True,
                "tprm_id": None,
            },
            {
                "key": "279",
                "source": "42616",
                "target": "42617",
                "link_type": "point_tmo_constraint",
                "enabled": True,
                "tprm_id": None,
            },
            {
                "key": "280",
                "source": "42616",
                "target": "42599",
                "link_type": "p_id",
                "enabled": True,
                "tprm_id": None,
            },
            {
                "key": "281",
                "source": "42600",
                "target": "42589",
                "link_type": "p_id",
                "enabled": True,
                "tprm_id": None,
            },
            {
                "key": "282",
                "source": "42617",
                "target": "42616",
                "link_type": "point_tmo_constraint",
                "enabled": True,
                "tprm_id": None,
            },
            {
                "key": "283",
                "source": "42617",
                "target": "42600",
                "link_type": "p_id",
                "enabled": True,
                "tprm_id": None,
            },
            {
                "key": "284",
                "source": "42592",
                "target": "42589",
                "link_type": "p_id",
                "enabled": True,
                "tprm_id": None,
            },
            {
                "key": "285",
                "source": "42611",
                "target": "42616",
                "link_type": "point_tmo_constraint",
                "enabled": True,
                "tprm_id": None,
            },
            {
                "key": "286",
                "source": "42611",
                "target": "42592",
                "link_type": "p_id",
                "enabled": True,
                "tprm_id": None,
            },
            {
                "key": "287",
                "source": "42591",
                "target": "42589",
                "link_type": "p_id",
                "enabled": True,
                "tprm_id": None,
            },
            {
                "key": "288",
                "source": "42610",
                "target": "42610",
                "link_type": "point_tmo_constraint",
                "enabled": True,
                "tprm_id": None,
            },
            {
                "key": "289",
                "source": "42610",
                "target": "42591",
                "link_type": "p_id",
                "enabled": True,
                "tprm_id": None,
            },
            {
                "key": "290",
                "source": "42604",
                "target": "42622",
                "link_type": "mo_link",
                "enabled": True,
                "tprm_id": 125952,
            },
            {
                "key": "291",
                "source": "42610",
                "target": "42622",
                "link_type": "mo_link",
                "enabled": True,
                "tprm_id": 125953,
            },
            {
                "key": "292",
                "source": "42611",
                "target": "42622",
                "link_type": "mo_link",
                "enabled": True,
                "tprm_id": 125954,
            },
            {
                "key": "293",
                "source": "42616",
                "target": "42622",
                "link_type": "mo_link",
                "enabled": True,
                "tprm_id": 125955,
            },
            {
                "key": "294",
                "source": "42617",
                "target": "42622",
                "link_type": "mo_link",
                "enabled": True,
                "tprm_id": 125956,
            },
        ],
        "group_by_tprms": [],
        "start_from_tmo_id": 42588,
        "start_from_tprm_id": None,
        "trace_tmo_id": None,
        "trace_tprm_id": None,
        "delete_orphan_branches": False,
    }

    # keys generate randomly request my request, so to compare expected response and real we need remove it
    expected_response = remove_keys_from_response(
        data=expected_response, key_to_delete="edges", attrs=["key"]
    )
    response_from_server = remove_keys_from_response(
        data=response_from_server_by_tmo_data.json(),
        key_to_delete="edges",
        attrs=["key"],
    )
    assert expected_response == response_from_server


def test_update_tmo_start_from_first_tmo_id(client):
    """
    PATCH /api/graph/tmo/{key}

        Endpoint update settings, on which we can build graph
        Here we test editing 'start_from_tmo_id' attribute
    """
    graphs = client.get(url="/api/graph/v1/initialisation/")
    graph_key = graphs.json()[0]["key"]

    request_to_update_tmo = {"start_from_tmo_id": 42589}

    response_from_updating_tmo = client.patch(
        url=f"/api/graph/v1/tmo/{graph_key}", json=request_to_update_tmo
    )
    assert response_from_updating_tmo.status_code == 200
    expected_response = {
        "start_node_key": "42588",
        "nodes": [
            {
                "key": "42588",
                "name": "Transport Network Small",
                "virtual": True,
                "global_uniqueness": True,
                "id": 42588,
                "materialize": False,
                "enabled": True,
                "is_grouped": False,
                "icon": "AccessibleForward",
                "geometry_type": None,
                "line_type": None,
                "params": [],
                "commutation_tprms": None,
                "show_as_a_table": True,
                "busy_parameter_groups": [],
            },
            {
                "key": "42622",
                "name": "Service Small",
                "virtual": False,
                "global_uniqueness": True,
                "id": 42622,
                "materialize": False,
                "enabled": True,
                "is_grouped": False,
                "icon": None,
                "geometry_type": None,
                "line_type": None,
                "params": [{"name": "Name", "val_type": "str", "id": 125951}],
                "commutation_tprms": None,
                "show_as_a_table": True,
                "busy_parameter_groups": [],
            },
            {
                "key": "42589",
                "name": "Location Small",
                "virtual": False,
                "global_uniqueness": True,
                "id": 42589,
                "materialize": False,
                "enabled": True,
                "is_grouped": False,
                "icon": "LocationOn",
                "geometry_type": None,
                "line_type": None,
                "params": [
                    {"name": "Name", "val_type": "str", "id": 125943},
                    {"name": "Latitude", "val_type": "float", "id": 125897},
                    {"name": "Longitude", "val_type": "float", "id": 125898},
                ],
                "commutation_tprms": None,
                "show_as_a_table": True,
                "busy_parameter_groups": [],
            },
            {
                "key": "42590",
                "name": "Sites Small",
                "virtual": False,
                "global_uniqueness": True,
                "id": 42590,
                "materialize": False,
                "enabled": True,
                "is_grouped": False,
                "icon": "CellTower",
                "geometry_type": None,
                "line_type": None,
                "params": [{"name": "Name", "val_type": "str", "id": 125914}],
                "commutation_tprms": None,
                "show_as_a_table": True,
                "busy_parameter_groups": [],
            },
            {
                "key": "42604",
                "name": "Site Port",
                "virtual": False,
                "global_uniqueness": False,
                "id": 42604,
                "materialize": False,
                "enabled": True,
                "is_grouped": False,
                "icon": "ImportExport",
                "geometry_type": None,
                "line_type": None,
                "params": [
                    {"name": "Name", "val_type": "str", "id": 125921},
                    {"name": "Trace", "val_type": "mo_link", "id": 125952},
                ],
                "commutation_tprms": None,
                "show_as_a_table": True,
                "busy_parameter_groups": [],
            },
            {
                "key": "42599",
                "name": "Optical Cross Small",
                "virtual": False,
                "global_uniqueness": True,
                "id": 42599,
                "materialize": False,
                "enabled": True,
                "is_grouped": False,
                "icon": "HdrStrong",
                "geometry_type": None,
                "line_type": None,
                "params": [{"name": "Name", "val_type": "str", "id": 125913}],
                "commutation_tprms": None,
                "show_as_a_table": True,
                "busy_parameter_groups": [],
            },
            {
                "key": "42616",
                "name": "Optical Cross Thread ",
                "virtual": False,
                "global_uniqueness": False,
                "id": 42616,
                "materialize": False,
                "enabled": True,
                "is_grouped": False,
                "icon": "ImportExport",
                "geometry_type": None,
                "line_type": None,
                "params": [
                    {"name": "Trace", "val_type": "mo_link", "id": 125955},
                    {"name": "Name", "val_type": "str", "id": 125941},
                ],
                "commutation_tprms": None,
                "show_as_a_table": True,
                "busy_parameter_groups": [],
            },
            {
                "key": "42600",
                "name": "Swith",
                "virtual": False,
                "global_uniqueness": True,
                "id": 42600,
                "materialize": False,
                "enabled": True,
                "is_grouped": False,
                "icon": "ToggleOff",
                "geometry_type": None,
                "line_type": None,
                "params": [{"name": "Name", "val_type": "str", "id": 125944}],
                "commutation_tprms": None,
                "show_as_a_table": True,
                "busy_parameter_groups": [],
            },
            {
                "key": "42617",
                "name": "Swith Port",
                "virtual": False,
                "global_uniqueness": False,
                "id": 42617,
                "materialize": False,
                "enabled": True,
                "is_grouped": False,
                "icon": "ImportExport",
                "geometry_type": None,
                "line_type": None,
                "params": [
                    {"name": "Name", "val_type": "str", "id": 125942},
                    {"name": "Trace", "val_type": "mo_link", "id": 125956},
                ],
                "commutation_tprms": None,
                "show_as_a_table": True,
                "busy_parameter_groups": [],
            },
            {
                "key": "42592",
                "name": "Fiber Cable Small",
                "virtual": False,
                "global_uniqueness": True,
                "id": 42592,
                "materialize": False,
                "enabled": True,
                "is_grouped": False,
                "icon": "FiberSmartRecord",
                "geometry_type": None,
                "line_type": None,
                "params": [{"name": "Name", "val_type": "str", "id": 125911}],
                "commutation_tprms": None,
                "show_as_a_table": True,
                "busy_parameter_groups": [],
            },
            {
                "key": "42611",
                "name": "Fiber Cable Thread",
                "virtual": False,
                "global_uniqueness": False,
                "id": 42611,
                "materialize": False,
                "enabled": True,
                "is_grouped": False,
                "icon": "ImportExport",
                "geometry_type": None,
                "line_type": None,
                "params": [
                    {"name": "Trace", "val_type": "mo_link", "id": 125954},
                    {"name": "Name", "val_type": "str", "id": 125930},
                ],
                "commutation_tprms": None,
                "show_as_a_table": True,
                "busy_parameter_groups": [],
            },
            {
                "key": "42591",
                "name": "Microwave Small",
                "virtual": False,
                "global_uniqueness": True,
                "id": 42591,
                "materialize": False,
                "enabled": True,
                "is_grouped": False,
                "icon": "Waves",
                "geometry_type": None,
                "line_type": None,
                "params": [{"name": "Name", "val_type": "str", "id": 125912}],
                "commutation_tprms": None,
                "show_as_a_table": True,
                "busy_parameter_groups": [],
            },
            {
                "key": "42610",
                "name": "Microwave Port",
                "virtual": False,
                "global_uniqueness": False,
                "id": 42610,
                "materialize": False,
                "enabled": True,
                "is_grouped": False,
                "icon": "ImportExport",
                "geometry_type": None,
                "line_type": None,
                "params": [
                    {"name": "Trace", "val_type": "mo_link", "id": 125953},
                    {"name": "Name", "val_type": "str", "id": 125933},
                ],
                "commutation_tprms": None,
                "show_as_a_table": True,
                "busy_parameter_groups": [],
            },
        ],
        "edges": [
            {
                "key": "455",
                "source": "42622",
                "target": "42588",
                "link_type": "p_id",
                "enabled": True,
                "tprm_id": None,
            },
            {
                "key": "456",
                "source": "42589",
                "target": "42588",
                "link_type": "p_id",
                "enabled": True,
                "tprm_id": None,
            },
            {
                "key": "457",
                "source": "42590",
                "target": "42589",
                "link_type": "p_id",
                "enabled": True,
                "tprm_id": None,
            },
            {
                "key": "458",
                "source": "42604",
                "target": "42590",
                "link_type": "p_id",
                "enabled": True,
                "tprm_id": None,
            },
            {
                "key": "459",
                "source": "42599",
                "target": "42611",
                "link_type": "point_tmo_constraint",
                "enabled": True,
                "tprm_id": None,
            },
            {
                "key": "460",
                "source": "42599",
                "target": "42589",
                "link_type": "p_id",
                "enabled": True,
                "tprm_id": None,
            },
            {
                "key": "461",
                "source": "42616",
                "target": "42611",
                "link_type": "point_tmo_constraint",
                "enabled": True,
                "tprm_id": None,
            },
            {
                "key": "462",
                "source": "42616",
                "target": "42617",
                "link_type": "point_tmo_constraint",
                "enabled": True,
                "tprm_id": None,
            },
            {
                "key": "463",
                "source": "42616",
                "target": "42599",
                "link_type": "p_id",
                "enabled": True,
                "tprm_id": None,
            },
            {
                "key": "464",
                "source": "42600",
                "target": "42589",
                "link_type": "p_id",
                "enabled": True,
                "tprm_id": None,
            },
            {
                "key": "465",
                "source": "42617",
                "target": "42616",
                "link_type": "point_tmo_constraint",
                "enabled": True,
                "tprm_id": None,
            },
            {
                "key": "466",
                "source": "42617",
                "target": "42600",
                "link_type": "p_id",
                "enabled": True,
                "tprm_id": None,
            },
            {
                "key": "467",
                "source": "42592",
                "target": "42589",
                "link_type": "p_id",
                "enabled": True,
                "tprm_id": None,
            },
            {
                "key": "468",
                "source": "42611",
                "target": "42616",
                "link_type": "point_tmo_constraint",
                "enabled": True,
                "tprm_id": None,
            },
            {
                "key": "469",
                "source": "42611",
                "target": "42592",
                "link_type": "p_id",
                "enabled": True,
                "tprm_id": None,
            },
            {
                "key": "470",
                "source": "42591",
                "target": "42589",
                "link_type": "p_id",
                "enabled": True,
                "tprm_id": None,
            },
            {
                "key": "471",
                "source": "42610",
                "target": "42610",
                "link_type": "point_tmo_constraint",
                "enabled": True,
                "tprm_id": None,
            },
            {
                "key": "472",
                "source": "42610",
                "target": "42591",
                "link_type": "p_id",
                "enabled": True,
                "tprm_id": None,
            },
            {
                "key": "473",
                "source": "42604",
                "target": "42622",
                "link_type": "mo_link",
                "enabled": True,
                "tprm_id": 125952,
            },
            {
                "key": "474",
                "source": "42610",
                "target": "42622",
                "link_type": "mo_link",
                "enabled": True,
                "tprm_id": 125953,
            },
            {
                "key": "475",
                "source": "42611",
                "target": "42622",
                "link_type": "mo_link",
                "enabled": True,
                "tprm_id": 125954,
            },
            {
                "key": "476",
                "source": "42616",
                "target": "42622",
                "link_type": "mo_link",
                "enabled": True,
                "tprm_id": 125955,
            },
            {
                "key": "477",
                "source": "42617",
                "target": "42622",
                "link_type": "mo_link",
                "enabled": True,
                "tprm_id": 125956,
            },
        ],
        "group_by_tprms": [],
        "start_from_tmo_id": 42589,
        "start_from_tprm_id": None,
        "trace_tmo_id": None,
        "trace_tprm_id": None,
        "delete_orphan_branches": False,
    }

    # remove keys, from EDGES(expected)
    expected_response = remove_keys_from_response(
        data=expected_response, key_to_delete="edges", attrs=["key"]
    )
    # remove keys, from EDGES(server)
    response_from_server = remove_keys_from_response(
        data=response_from_updating_tmo.json(),
        key_to_delete="edges",
        attrs=["key"],
    )
    assert expected_response == response_from_server


def test_set_communication_tprms(client, arango_client):
    """
    PATCH /api/graph/v1/{key}/tprms

        Endpoint give data by node key and tprm list
    """
    graphs = client.get(url="/api/graph/v1/initialisation/")
    graph_key = graphs.json()[0]["key"]

    req = {"node_key": "42604", "tprm_ids": ["125952"]}
    res = client.patch(url=f"/api/graph/v1/tmo/{graph_key}/tprms", json=req)
    assert res.status_code == 200

    resp = {
        "key": "42604",
        "name": "Site Port",
        "virtual": False,
        "global_uniqueness": False,
        "id": 42604,
        "materialize": False,
        "enabled": True,
        "is_grouped": False,
        "icon": "ImportExport",
        "geometry_type": None,
        "line_type": None,
        "params": [
            {"name": "Name", "val_type": "str", "id": 125921},
            {"name": "Trace", "val_type": "mo_link", "id": 125952},
        ],
        "commutation_tprms": [125952],
        "show_as_a_table": True,
        "busy_parameter_groups": [],
    }

    del resp["key"]

    res = res.json()
    del res["key"]

    assert res == resp
